<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ibtd &#8212; Iceberg Beacon Track Database (IBTD) Tools 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=27fed22d" />
    <script src="../_static/documentation_options.js?v=8d563738"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ibtd</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ibtd.py</span>

<span class="sd">Main module for the Iceberg Beacon Track Database (IBTD).</span>

<span class="sd">Defines the class:</span>
<span class="sd">    &#39;Track&#39; containing an individual iceberg track along with methods and properties.</span>

<span class="sd">    &#39;Meta&#39; containing the track metadata</span>

<span class="sd">    &#39;Specs&#39; containing beacon model specifications, used for purging bad data and adding properties</span>

<span class="sd">Note that creating an instance of a Track that _is_ in the standard format assumes the track</span>
<span class="sd"> has been processed, which means all the steps in a workflow for standardizing, purging, filtering</span>
<span class="sd"> and adding derived data are complete.</span>

<span class="sd">The functions to read the various raw_data formats and define the standard format are in track_readers.py</span>
<span class="sd">The functions to plot figures are in track_fig.py</span>

<span class="sd">The Database itself is created using this code base.  To (re-)create the Database use track_collate.py</span>

<span class="sd">Author: Derek Mueller, Water and Ice Research Laboratory (WIRL), Carleton University</span>

<span class="sd">Copyright (C) 2025  WIRL</span>

<span class="sd">    This program is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    This program is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># imports</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">geopandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gpd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">shapely.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="n">LineString</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyproj</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>

<span class="c1"># this functionality is in other modules.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">track_readers</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">track_fig</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_trim</span><span class="p">,</span> <span class="n">plot_map</span><span class="p">,</span> <span class="n">plot_dist</span><span class="p">,</span> <span class="n">plot_time</span>

<span class="c1"># turn on the copy-on-write functionality</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">copy_on_write</span> <span class="o">=</span> <span class="kc">True</span>


<div class="viewcode-block" id="nolog">
<a class="viewcode-back" href="../api.html#ibtd.nolog">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">nolog</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a logger instance that doesn&#39;t do anything.</span>

<span class="sd">    Used to allow logging or not in the code below</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    NoOpLogger</span>
<span class="sd">        A named tuple that mimics a log instance.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">NoOpLogger</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span>
        <span class="s2">&quot;NoOpLogger&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;critical&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">NoOpLogger</span><span class="p">(</span><span class="o">*</span><span class="p">([</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span><span class="p">))</span></div>



<div class="viewcode-block" id="json_serialize">
<a class="viewcode-back" href="../api.html#ibtd.json_serialize">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">json_serialize</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check to see if the value is a type that json can&#39;t serialize and, if so, convert it.</span>

<span class="sd">    In practice that means converting datetime to string and numpy boolean to regular T/F</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value : Any variable</span>
<span class="sd">        A variable.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    value</span>
<span class="sd">        a value in a format json can serialize</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>



<div class="viewcode-block" id="Specs">
<a class="viewcode-back" href="../api.html#ibtd.Specs">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Specs</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class that holds info/specifications for all beacon models.</span>

<span class="sd">    Currently this is the valid range (min, max) of various sensors and some beacon attributes</span>
<span class="sd">    but this could be expanded to hold any data related to the model.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specs_file</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read beacon specification file and create a dataframe.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        model_file : str</span>
<span class="sd">            Full path to the model_file (*.ods or *.xls or *.xlsx).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">nolog</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logger</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">specs_file</span> <span class="o">=</span> <span class="n">specs_file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">specs_file</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Beacon specifications file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">specs_file</span><span class="si">}</span><span class="s2"> read error&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model specifications file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">specs_file</span><span class="si">}</span><span class="s2"> read&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="Meta">
<a class="viewcode-back" href="../api.html#ibtd.Meta">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class that reads a metadata file and stores all rows in a dataframe.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">meta_file</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read metadata file and create a dataframe.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        meta_file : str</span>
<span class="sd">            Full path to the beacon metadata file. (*.xls, *.xlsx, *.ods)</span>
<span class="sd">        logger: instance of logger class</span>
<span class="sd">            Pass a logger here if you want</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">nolog</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logger</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing Meta instance from </span><span class="si">{</span><span class="n">meta_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">meta_file</span> <span class="o">=</span> <span class="n">meta_file</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="n">meta_file</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;wmo&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">})</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to read </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_file</span><span class="si">}</span><span class="s2">, exiting... &quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to read </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Track metadata file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_file</span><span class="si">}</span><span class="s2"> read&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="Track">
<a class="viewcode-back" href="../api.html#ibtd.Track">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Track</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing an iceberg beacon track.</span>

<span class="sd">    This track could be a raw data file or a track that has been processed into a</span>
<span class="sd">    the standard format.</span>

<span class="sd">    Tracks have many properties and methods for data purging, filtering, inspection and analysis.</span>


<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    datafile : str</span>
<span class="sd">        Path to the raw or standardized data file.</span>
<span class="sd">    platform_id : str</span>
<span class="sd">        Identifier for the platform (from filename stem).</span>
<span class="sd">    year : str</span>
<span class="sd">        Year of the platform deployment (from filename).</span>
<span class="sd">    id : str</span>
<span class="sd">        Unique identifier for the beacon (from filename).</span>
<span class="sd">    data : pandas.DataFrame</span>
<span class="sd">        DataFrame containing the track data (timestamp, latitude, longitude, etc.).</span>
<span class="sd">    raw_data : bool</span>
<span class="sd">        True if track is from raw data, False if standardized.</span>
<span class="sd">    reader : str</span>
<span class="sd">        Name of the reader function used to load the data.</span>
<span class="sd">    model : str or None</span>
<span class="sd">        Name of the beacon model.</span>
<span class="sd">    trim_start : pandas.Timestamp or None</span>
<span class="sd">        Timestamp for the start trim of the track.</span>
<span class="sd">    trim_end : pandas.Timestamp or None</span>
<span class="sd">        Timestamp for the end trim of the track.</span>
<span class="sd">    data_start : pandas.Timestamp</span>
<span class="sd">        Timestamp of the first data point in the file.</span>
<span class="sd">    data_end : pandas.Timestamp</span>
<span class="sd">        Timestamp of the last data point in the file.</span>
<span class="sd">    track_start : pandas.Timestamp</span>
<span class="sd">        Timestamp of the first valid data point after trimming/filtering.</span>
<span class="sd">    track_end : pandas.Timestamp</span>
<span class="sd">        Timestamp of the last valid data point after trimming/filtering.</span>
<span class="sd">    duration : float</span>
<span class="sd">        Duration of the track in days.</span>
<span class="sd">    observations : int</span>
<span class="sd">        Number of valid data points in the track.</span>
<span class="sd">    latitude_start : float or None</span>
<span class="sd">        Starting latitude (after sorting).</span>
<span class="sd">    longitude_start : float or None</span>
<span class="sd">        Starting longitude (after sorting).</span>
<span class="sd">    latitude_end : float or None</span>
<span class="sd">        Ending latitude (after sorting).</span>
<span class="sd">    longitude_end : float or None</span>
<span class="sd">        Ending longitude (after sorting).</span>
<span class="sd">    distance_travelled : float or None</span>
<span class="sd">        Total distance travelled by the platform (km).</span>
<span class="sd">    purged : bool</span>
<span class="sd">        True if bad data have been purged.</span>
<span class="sd">    sorted : bool</span>
<span class="sd">        True if the data have been sorted chronologically.</span>
<span class="sd">    speeded : bool</span>
<span class="sd">        True if speed/displacement calculations have been performed.</span>
<span class="sd">    speedlimited : bool</span>
<span class="sd">        True if speed limit filtering has been applied.</span>
<span class="sd">    trimmed : bool</span>
<span class="sd">        True if the track has been trimmed.</span>
<span class="sd">    trimmed_start : bool</span>
<span class="sd">        True if the start of the track has been trimmed.</span>
<span class="sd">    trimmed_end : bool</span>
<span class="sd">        True if the end of the track has been trimmed.</span>
<span class="sd">    geoed : bool</span>
<span class="sd">        True if geospatial objects have been created.</span>
<span class="sd">    trackpoints : geopandas.GeoDataFrame or None</span>
<span class="sd">        Geodataframe of track points (created by geo()).</span>
<span class="sd">    trackline : geopandas.GeoSeries or None</span>
<span class="sd">        Geospatial line representing the track (created by geo()).</span>
<span class="sd">    meta_dict : dict</span>
<span class="sd">        Additional metadata loaded from the Meta object.</span>
<span class="sd">    log : logging.Logger or NoOpLogger</span>
<span class="sd">        Logger instance used for logging messages.</span>

<span class="sd">    # Beacon/model specification attributes (if loaded via load_model_specs)</span>
<span class="sd">    make : str</span>
<span class="sd">        Beacon manufacturer.</span>
<span class="sd">    transmitter : str</span>
<span class="sd">        Transmitter type/model.</span>
<span class="sd">    air_deployable : bool</span>
<span class="sd">        Whether the beacon is air deployable.</span>
<span class="sd">    buoyant : bool</span>
<span class="sd">        Whether the beacon is buoyant.</span>
<span class="sd">    has_internal_temperature : bool</span>
<span class="sd">        If the beacon has an internal temperature sensor.</span>
<span class="sd">    has_surface_temperature : bool</span>
<span class="sd">        If the beacon has a surface temperature sensor.</span>
<span class="sd">    has_air_temperature : bool</span>
<span class="sd">        If the beacon has an air temperature sensor.</span>
<span class="sd">    has_air_pressure : bool</span>
<span class="sd">        If the beacon has an air pressure sensor.</span>
<span class="sd">    has_platform_pitch : bool</span>
<span class="sd">        If the beacon has a pitch sensor.</span>
<span class="sd">    has_platform_roll : bool</span>
<span class="sd">        If the beacon has a roll sensor.</span>
<span class="sd">    has_platform_orientation : bool</span>
<span class="sd">        If the beacon has an orientation sensor.</span>
<span class="sd">    has_voltage_battery_volts : bool</span>
<span class="sd">        If the beacon has a battery voltage sensor.</span>

<span class="sd">    # Valid range attributes (if loaded via load_model_specs)</span>
<span class="sd">    latitude_min, latitude_max : float</span>
<span class="sd">        Valid range for latitude.</span>
<span class="sd">    longitude_min, longitude_max : float</span>
<span class="sd">        Valid range for longitude.</span>
<span class="sd">    air_temperature_min, air_temperature_max : float</span>
<span class="sd">        Valid range for air temperature.</span>
<span class="sd">    internal_temperature_min, internal_temperature_max : float</span>
<span class="sd">        Valid range for internal temperature.</span>
<span class="sd">    surface_temperature_min, surface_temperature_max : float</span>
<span class="sd">        Valid range for surface temperature.</span>
<span class="sd">    air_pressure_min, air_pressure_max : float</span>
<span class="sd">        Valid range for air pressure.</span>
<span class="sd">    platform_pitch_min, platform_pitch_max : float</span>
<span class="sd">        Valid range for platform pitch.</span>
<span class="sd">    platform_roll_min, platform_roll_max : float</span>
<span class="sd">        Valid range for platform roll.</span>
<span class="sd">    platform_orientation_min, platform_orientation_max : float</span>
<span class="sd">        Valid range for platform orientation.</span>
<span class="sd">    voltage_battery_volts_min, voltage_battery_volts_max : float</span>
<span class="sd">        Valid range for battery voltage.</span>


<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    geo()</span>
<span class="sd">        Add a geodataframe of track points and a track line to the track object.</span>
<span class="sd">    load_metadata(Meta)</span>
<span class="sd">        Read the metadata record for this track and overwrite track properties.</span>
<span class="sd">    load_model_specs(Specs)</span>
<span class="sd">        Load the specific specifications for this beacon and write them to track properties.</span>
<span class="sd">    purge()</span>
<span class="sd">        Purge bad data by assigning NaN to values that exceed the min/max range.</span>
<span class="sd">    sort()</span>
<span class="sd">        Order the track chronologically and remove redundant entries.</span>
<span class="sd">    speed()</span>
<span class="sd">        Calculate displacement, speed, and course bearing between iceberg positions.</span>
<span class="sd">    speed_limit(threshold=2.5)</span>
<span class="sd">        Remove gross speeding violations from data.</span>
<span class="sd">    trim()</span>
<span class="sd">        Trim a track from data_start/end with trim_start/end to yield a track from track_start to _end.</span>
<span class="sd">    output(types=[&#39;csv&#39;], path_output=&#39;.&#39;, file_name=None)</span>
<span class="sd">        Output the track to a file in various formats.</span>
<span class="sd">    resample(timestep=&#39;D&#39;, agg_function=None, first=True)</span>
<span class="sd">        Resample track to a given time step.</span>
<span class="sd">    track_metadata(path_output=&#39;.&#39;, meta_export=None, verbose=False)</span>
<span class="sd">        Make a dataframe and dictionary of the known track metadata for export.</span>
<span class="sd">    plot_map(path_output=&#39;.&#39;, interactive=False, dpi=300)</span>
<span class="sd">        Plot a map of the track.</span>
<span class="sd">    plot_trim(path_output=&#39;.&#39;, interactive=False, dpi=300)</span>
<span class="sd">        Plot a trim diagnostic graph for the track.</span>
<span class="sd">    plot_dist(path_output=&#39;.&#39;, interactive=False, dpi=300)</span>
<span class="sd">        Plot distributions along the track.</span>
<span class="sd">    plot_time(path_output=&#39;.&#39;, interactive=False, dpi=300)</span>
<span class="sd">        Plot a timeseries of the track.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data_file</span><span class="p">,</span>
        <span class="n">reader</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span><span class="p">,</span>
        <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">trim_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">trim_end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">raw_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the track raw or standardized data.</span>

<span class="sd">        Note the default is to read standardized data (which assumes it was fully processed)</span>
<span class="sd">        If track metadata is provided, that info will be used; otherwise properties</span>
<span class="sd">        will be set from keywords here</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_file : str</span>
<span class="sd">            path to the raw/standard data file.</span>
<span class="sd">        reader : str, optional</span>
<span class="sd">            name of the reader function to use. The default is &quot;standard&quot;.</span>
<span class="sd">        model : str, optional</span>
<span class="sd">            name of the beacon model. The default is None.</span>
<span class="sd">        trim_start : str, optional</span>
<span class="sd">            timestamp to trim the start of the track. The default is None.</span>
<span class="sd">        trim_end : str, optional</span>
<span class="sd">            timestamp to trim the end of the track. The default is None.</span>
<span class="sd">        metadata : Meta Class, optional</span>
<span class="sd">            An object of the Meta class. The default is None.</span>
<span class="sd">        raw_data : bool, optional</span>
<span class="sd">            Set to true if you are working with raw data.  The default is False.</span>
<span class="sd">        logger : logger instance, optional</span>
<span class="sd">            A logger instance to log to. The default is None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="n">nolog</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">logger</span>  <span class="c1"># a log instance is now part of the class</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing track instance from </span><span class="si">{</span><span class="n">data_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">datafile</span> <span class="o">=</span> <span class="n">data_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">platform_id</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datafile</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>

        <span class="c1"># raw_data flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span> <span class="o">=</span> <span class="n">raw_data</span>

        <span class="c1"># if metadata is not given then set properties</span>
        <span class="k">if</span> <span class="n">metadata</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">reader</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trim_start</span> <span class="o">=</span> <span class="n">trim_start</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trim_end</span> <span class="o">=</span> <span class="n">trim_end</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

        <span class="c1"># this simply overrides the reader column in the metadata</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="s2">&quot;standard&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Reading data from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">datafile</span><span class="si">}</span><span class="s2"> using the </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="si">}</span><span class="s2"> reader&quot;</span>
        <span class="p">)</span>

        <span class="n">reader_function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">track_readers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">reader_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datafile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Track rows: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> - after data file read&quot;</span><span class="p">)</span>

        <span class="c1"># at a minimum this step should be taken since a track must have all 3 of these</span>
        <span class="c1"># Drop all rows where timestamp, latitude or longitude is nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Track rows: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;longitude&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s1"> rows removed because NAs found in timestamp or position&#39;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Track rows: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> - after NAs removed&quot;</span><span class="p">)</span>

        <span class="c1"># check here to see if there are any data in the track.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No data read from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">datafile</span><span class="si">}</span><span class="s2"> using the </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="si">}</span><span class="s2"> reader&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No data read from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">datafile</span><span class="si">}</span><span class="s2"> using the </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reader</span><span class="si">}</span><span class="s2"> reader&quot;</span>
            <span class="p">)</span>

        <span class="c1"># make sure these datetimes convert ok</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim_start</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trim_start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trim_start</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unrecognized trim start format&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Check trim start value&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim_end</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trim_end</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trim_end</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unrecognized track end format&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Check track end value&quot;</span><span class="p">)</span>

        <span class="c1"># This captures the data file start and end</span>
        <span class="c1"># note that this value *may* not match the actual file data since some reader functions</span>
        <span class="c1"># remove bad data beforehand</span>
        <span class="c1"># The data_start and _end won&#39;t change from here on.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="c1"># in case the trim_start or trim_end is not set, set it to the widest range possible</span>
        <span class="c1"># report the difference between the data_start/end and the trim_start/end</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim_start</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trim_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;trim_start not specified, the track_start was set to the time of the first valid data point (data_start)&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim_start</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;trim_start was set to </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span><span class="si">}</span><span class="s2"> before the first valid data point (data_start)&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;trim_start was set exactly to the first valid data point (data_start)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;trim_start was set to </span><span class="si">{</span><span class="n">delta</span><span class="si">}</span><span class="s2"> after the first valid data point (data_start)&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim_end</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trim_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;trim_end not specified, the track_end was set to the time of the last valid data point (data_end)&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim_end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;trim_end was set to </span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span><span class="si">}</span><span class="s2"> before the last valid data point (data_end)&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s2">&quot;trim_end was set exactly to the last valid data point (data_end)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;trim_end was set to </span><span class="si">{</span><span class="n">delta</span><span class="si">}</span><span class="s2"> after the last valid data point (data_end)&quot;</span>
                <span class="p">)</span>

        <span class="c1"># These will be added later - after track is geod.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trackpoints</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trackline</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># These properties record what has been done to the track.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">purged</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speeded</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speedlimited</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trimmed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geoed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># if the reader is standard then assume this has been done previously.</span>
        <span class="c1"># if you want to re-process data set the reader to standard and the raw_data to True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">==</span> <span class="s2">&quot;standard&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">purged</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">speeded</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">speedlimited</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trimmed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># refresh track limits and track stats.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_stats</span><span class="p">()</span>

        <span class="c1"># some outputs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Raw data read-in with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">observations</span><span class="si">}</span><span class="s2"> rows of valid data from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_start</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_end</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Standard data read-in with </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">observations</span><span class="si">}</span><span class="s2"> rows of valid data from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_start</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_end</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="Track.refresh_stats">
<a class="viewcode-back" href="../api.html#ibtd.Track.refresh_stats">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">refresh_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">speed</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Refresh track limits, stats, speed calcs and geodata.</span>

<span class="sd">        Do this after any changes in the dataframe. If you are running this after the speed</span>
<span class="sd">        function set speed=False or it will loop forever.</span>

<span class="sd">        1) Ensure track_start and track_end represent the current range of valid track data.</span>

<span class="sd">        Also, in theory the trim_start should not be &lt;&lt; data_start and the trim_end should</span>
<span class="sd">        not be &gt;&gt; data_end.  If that is so, warn about this in the log.</span>

<span class="sd">        This could be due to an operator error (trim value for the wrong track for example)</span>
<span class="sd">        But this does not necessarily mean there is an issue! This can happen when the</span>
<span class="sd">        beacon is deployed but not activated or when data at the start or end of the</span>
<span class="sd">        track is deemed non-valid by various purging/filtering functions.</span>

<span class="sd">        2) Rerun the speed method which calculates the speed_wrt_ground, displacement and course</span>
<span class="sd">            between positions.</span>

<span class="sd">        3) Recreate the geospatial tracklines and trackpoints for the track.</span>

<span class="sd">        4) Calculate track stats, whcih includes the observations, duration and distance travelled</span>
<span class="sd">            for the track, as well as the starting and ending latitude and longitude.</span>

<span class="sd">        Be sure to run this after all purging/filtering steps after sorting the data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        speed : bool, optional</span>
<span class="sd">            If true refresh_stats will recalculate speed. The default is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Refreshing track stats&quot;</span><span class="p">)</span>

        <span class="c1"># make sure there is actually data:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;There is no track data anymore, check that data filtering &quot;</span>
                <span class="s2">&quot;or trimming didn&#39;t wipe it all out!&quot;</span>
            <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># now set the track range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">timestamp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="c1"># reset the index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># recalculate the speed and displacement</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speeded</span> <span class="ow">and</span> <span class="n">speed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">speed</span><span class="p">()</span>
        <span class="c1"># self.speed_limit() # Assuming this is not needed here but leaving comment to flag this step</span>
        <span class="c1"># if you have geospatial data, it must be recreated</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="p">()</span>

        <span class="c1"># populate some simple properties that all tracks have</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_start</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">duration</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="n">duration</span><span class="o">.</span><span class="n">seconds</span> <span class="o">/</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observations</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># this only works after some processing or if the data are standard</span>
        <span class="c1"># note this will change when trimmed too...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latitude_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">longitude_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latitude_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">longitude_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latitude_start</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">longitude_start</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">latitude_end</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">longitude_end</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">speeded</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distance_travelled</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_displacement&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">distance_travelled</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Track.load_model_specs">
<a class="viewcode-back" href="../api.html#ibtd.Track.load_model_specs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_model_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Specs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the specific specifications for this beacon and write them to track properties.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Specs : Specs class</span>
<span class="sd">            Specifications for all beacon models</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reading model specifications&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Model not known. Check input&quot;</span><span class="p">)</span>

        <span class="n">default_specs</span> <span class="o">=</span> <span class="n">Specs</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Specs</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;Default&quot;</span><span class="p">]</span>
        <span class="n">beacon_specs</span> <span class="o">=</span> <span class="n">Specs</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Specs</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">default_specs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Unkown Default model, check spelling -or- duplicate model retrieved&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">beacon_specs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unkown model </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">, check spelling -or- duplicate model retrieved&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># find which specs are meant to be &#39;default&#39;and replace with default</span>
        <span class="n">beacon_specs_ind</span> <span class="o">=</span> <span class="n">beacon_specs</span><span class="o">.</span><span class="n">loc</span><span class="p">[:]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="s2">&quot;?&quot;</span>
        <span class="n">beacon_specs_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">beacon_specs_ind</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">beacon_specs_ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">beacon_specs_ind</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span>
        <span class="n">beacon_specs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">beacon_specs_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_specs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">beacon_specs_ind</span><span class="p">]</span>

        <span class="c1"># remove a few columns that are not needed</span>
        <span class="n">beacon_specs</span> <span class="o">=</span> <span class="n">beacon_specs</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;notes&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">])</span>

        <span class="c1"># set to boolean</span>
        <span class="n">beacon_specs</span> <span class="o">=</span> <span class="n">beacon_specs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;air_deployable&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="s2">&quot;buoyant&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="s2">&quot;has_internal_temperature&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="s2">&quot;has_surface_temperature&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="s2">&quot;has_air_temperature&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="s2">&quot;has_air_pressure&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="s2">&quot;has_platform_pitch&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="s2">&quot;has_platform_roll&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="s2">&quot;has_platform_orientation&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="s2">&quot;has_voltage_battery_volts&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># put the contents of the specs df into the track properities</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">beacon_specs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">beacon_specs</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># now coerce the data to floats</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="n">beacon_specs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">regex</span><span class="o">=</span><span class="s2">&quot;_max|_min&quot;</span><span class="p">)</span>
        <span class="n">specs</span> <span class="o">=</span> <span class="n">specs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

        <span class="c1"># overwrite the properties above but with proper data types</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">specs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">specs</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="Track.load_metadata">
<a class="viewcode-back" href="../api.html#ibtd.Track.load_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Meta</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the metadata record for this track and overwrite track properties.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Meta : Meta object</span>
<span class="sd">            An instance of the class Meta representing a dataframe of metadata.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading track metadata&quot;</span><span class="p">)</span>
        <span class="c1"># filter records to find the data for this beacon</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">Meta</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Meta</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">platform_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform_id</span><span class="p">]</span>
        <span class="c1"># check that one and only one record is returned</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;metadata not found, exiting....&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The metadata for beacon </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">platform_id</span><span class="si">}</span><span class="s2"> was not found&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;beacon metadata duplicated, exiting....&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The metadata search for beacon </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">platform_id</span><span class="si">}</span><span class="s2"> returned duplicate records&quot;</span>
            <span class="p">)</span>

        <span class="c1"># load properties</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">reader</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reader</span> <span class="o">=</span> <span class="s2">&quot;standard&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;Default&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trim_start</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">trim_start</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trim_start</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trim_end</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">trim_end</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trim_end</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Beacon model: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;trim_start: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trim_start</span><span class="si">}</span><span class="s2"> and trim_end: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trim_end</span><span class="si">}</span><span class="s2"> requested&quot;</span>
        <span class="p">)</span>

        <span class="c1"># convert to datetime and check for errors</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim_start</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trim_start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trim_start</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Unrecognized track start format - trimming will not work as expected&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim_end</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trim_end</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trim_end</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Unrecognized track end format - trimming will not work as expected&quot;</span>
                <span class="p">)</span>

        <span class="c1"># next pull in all the remaining available metadata and store it as meta_dict</span>
        <span class="n">record</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;platform_id&quot;</span><span class="p">,</span> <span class="s2">&quot;reader&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;trim_start&quot;</span><span class="p">,</span> <span class="s2">&quot;trim_end&quot;</span><span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_dict</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span></div>


<div class="viewcode-block" id="Track.purge">
<a class="viewcode-back" href="../api.html#ibtd.Track.purge">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">purge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Purge bad data by assigning NaN to values that exceed the min/max range.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Purging bad data from track&quot;</span><span class="p">)</span>

        <span class="c1"># this tests whether you have specs read in...</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">make</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No beacon specs are available, no data purging attempted&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Latitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">latitude_max</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">latitude_min</span><span class="p">),</span>
            <span class="s2">&quot;latitude&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Longitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">longitude_max</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">longitude_min</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s2">&quot;longitude&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Air temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;air_temperature&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">air_temperature_max</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;air_temperature&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">air_temperature_min</span><span class="p">),</span>
            <span class="s2">&quot;air_temperature&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Internal temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;internal_temperature&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_temperature_max</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;internal_temperature&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">internal_temperature_min</span><span class="p">),</span>
            <span class="s2">&quot;internal_temperature&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Surface temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;surface_temperature&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface_temperature_max</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;surface_temperature&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">surface_temperature_min</span><span class="p">),</span>
            <span class="s2">&quot;surface_temperature&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Pressure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;air_pressure&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">air_pressure_max</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;air_pressure&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">air_pressure_min</span><span class="p">),</span>
            <span class="s2">&quot;air_pressure&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Pitch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_pitch&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform_pitch_max</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_pitch&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform_pitch_min</span><span class="p">),</span>
            <span class="s2">&quot;platform_pitch&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Roll</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_roll&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform_roll_max</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_roll&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform_roll_min</span><span class="p">),</span>
            <span class="s2">&quot;platform_roll&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Heading</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_orientation&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform_orientation_max</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_orientation&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform_orientation_min</span><span class="p">),</span>
            <span class="s2">&quot;platform_orientation&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Battery voltage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;voltage_battery_volts&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">voltage_battery_volts_max</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;voltage_battery_volts&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">voltage_battery_volts_min</span><span class="p">),</span>
            <span class="s2">&quot;voltage_battery_volts&quot;</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># Drop all rows where timestamp, latitude or longitude is nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="s2">&quot;longitude&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;air_temperature&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;internal_temperature&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;surface_temperature&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;air_pressure&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;platform_pitch&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;platform_roll&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;platform_orientation&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;voltage_battery_volts&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">purged</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Track bad data purged&quot;</span><span class="p">)</span>

        <span class="c1"># recalculate stats here since things may have changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_stats</span><span class="p">()</span></div>


<div class="viewcode-block" id="Track.sort">
<a class="viewcode-back" href="../api.html#ibtd.Track.sort">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sort</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Order the track chronologically and remove redundant entries.</span>

<span class="sd">        Some data formats are ordered in reverse, whereas others can have duplicates.</span>
<span class="sd">        This function takes care of these issues.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># sort by timestamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># look for repeated values</span>
        <span class="c1"># sdf_dup = self.data.loc[self.data.duplicated(subset=[&quot;timestamp&quot;], keep=False)] # all lines</span>
        <span class="n">sdf_dup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;last&quot;</span><span class="p">)</span>
        <span class="p">]</span>  <span class="c1"># keep last dup</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Track rows: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sdf_dup</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows removed due to duplicate timestamps&quot;</span>
            <span class="p">)</span>
        <span class="c1"># remove all rows with duplicate times, prefer the one with best location accuracy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span>
            <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span> <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;last&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># this should be true (check!)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
            <span class="s2">&quot;timestamp&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">is_monotonic_increasing</span><span class="p">,</span> <span class="s2">&quot;Issue with timestamps, sort data!&quot;</span>

        <span class="c1"># recalculate stats here since things may have changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_stats</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sorted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Track sorted, duplicates removed (if any). The track now has </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">observations</span><span class="si">}</span><span class="s2"> rows&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Track.speed">
<a class="viewcode-back" href="../api.html#ibtd.Track.speed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">speed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate displacement, speed and course bearing between iceberg positions.</span>

<span class="sd">        - platform_displacement : Distance from previous to current track position</span>
<span class="sd">        - platform_speed_wrt_ground : Speed from previous to current track position</span>
<span class="sd">        - platform_course :	Azimuth relative to true north from previous to current track position</span>

<span class="sd">        The speed is rounded to 3 decimal places and direction and distance are rounded</span>
<span class="sd">        to 0 decimal places which is plenty for sig figs. Since they are floating point values, they</span>
<span class="sd">        export like ##.0, implying a precision that does not exist.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure rows are sorted by datetime.</span>
        <span class="c1"># assert self.data[</span>
        <span class="c1">#     &quot;timestamp&quot;</span>
        <span class="c1"># ].is_monotonic_increasing, &quot;Issue with timestamps, sort data!&quot;</span>

        <span class="c1"># Initialize pyproj with appropriate ellipsoid</span>
        <span class="n">geodesic</span> <span class="o">=</span> <span class="n">pyproj</span><span class="o">.</span><span class="n">Geod</span><span class="p">(</span><span class="n">ellps</span><span class="o">=</span><span class="s2">&quot;WGS84&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate forward azimuth and great circle distance between modelled coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_course&quot;</span><span class="p">],</span> <span class="n">backaz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_displacement&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">geodesic</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Convert azimuth from (-180° to 180°) to (0° to 360°)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_course&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_course&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">360</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>
        <span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1">## Note here that no displacement (same lat/lon repeated) yields platform_course 180</span>
        <span class="c1">## and displacement 0 in the NH.  In SH it is course 0 and displacement 0 which might</span>
        <span class="c1">## need to be considered if there is SH data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_displacement&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;platform_course&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="p">)</span>

        <span class="c1"># Calculate time delta between rows (in seconds)</span>
        <span class="n">time_delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

        <span class="c1"># Calculate speed in m/s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_speed_wrt_ground&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_displacement&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">time_delta</span>
        <span class="p">)</span>

        <span class="c1"># Round columns</span>
        <span class="c1"># to assess whether there are consecutive duplicate positions, comment these lines</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_displacement&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_displacement&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_course&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_course&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_speed_wrt_ground&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
            <span class="s2">&quot;platform_speed_wrt_ground&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># set property</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speeded</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calculated displacement, direction and speed for track&quot;</span><span class="p">)</span>

        <span class="c1"># recalculate stats here since things may have changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_stats</span><span class="p">(</span><span class="n">speed</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="Track.speed_limit">
<a class="viewcode-back" href="../api.html#ibtd.Track.speed_limit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">speed_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">2.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove gross speeding violations from data.</span>

<span class="sd">        Note the intent here is to remove only the very worst rows from datasets.  It is</span>
<span class="sd">        a very crude way to cut down on *clearly wrong* position data.  Note high speeds are</span>
<span class="sd">        often due to inaccurate positions, but also inprecise positions over short periods</span>
<span class="sd">        of time. (eg., an Argos position 1-2 min apart may exceed a threshold even if</span>
<span class="sd">        precision is relatively good).</span>

<span class="sd">        The default value here is 2.5 m/s or 9 kph or 216 km/d (this is very conservative</span>
<span class="sd">        to avoid throwing away data.</span>

<span class="sd">        The algorithm removes the first point with the speed &gt; threshold and then</span>
<span class="sd">        recalculates the speed again for the track and reruns the filtering to remove the</span>
<span class="sd">        next point with speed &gt; threshold.</span>

<span class="sd">        This action is a good way to catch &#39;flyers&#39; where random position errors cause a</span>
<span class="sd">        jump in speed away from the track and then, typically, the position then returns to</span>
<span class="sd">        along the original track.</span>

<span class="sd">        Note, speed represents the displacement/time _between_ 2 points, but is recorded</span>
<span class="sd">        in the same row as the second point (i.e., a row&#39;s speed is the speed from the</span>
<span class="sd">        previous point up to the current point. Since the first row with speed &gt; threshold</span>
<span class="sd">        is removed, implicitly this assumes that the second point is invalid. This may</span>
<span class="sd">        not be true (point 1 or both point 1 and 2 might be at fault). Finding out what</span>
<span class="sd">        is going on is challenging.</span>

<span class="sd">        This scenario is a &#39;track shift&#39; where the entire track shifts position and in the</span>
<span class="sd">        intervening time (between the new position and the old position) the speed was &gt;</span>
<span class="sd">        threshold.</span>

<span class="sd">        Track shifts can come in two forms:</span>

<span class="sd">        1) If the second point in the entire track has speed &gt; threshold, this could be due</span>
<span class="sd">            to an invalid first point.</span>

<span class="sd">        2) If there is a shift in the middle of the track, whereby the speed jumps &gt;</span>
<span class="sd">            threshold but the next speed value is &lt; threshold.</span>

<span class="sd">        In both cases, because the speed_limit function loops and is, by nature, greedy,</span>
<span class="sd">        a lot of potentially good data could be removed until the speed falls &lt; threshold.</span>
<span class="sd">        If either situation arises, a warning will be logged, but the row in question</span>
<span class="sd">        will still be removed.</span>

<span class="sd">        If the warning is repeated more than once in a row, the raw data should be investigated.</span>
<span class="sd">        Is the removal of data justified? Was the trimming done correctly?  For example,</span>
<span class="sd">        in an untrimmed track, this type of issue could be due to testing a beacon at</span>
<span class="sd">        an airport overnight, flying for 30 minutes and deploying it on an iceberg.</span>
<span class="sd">        Track shifts are not likely to arise naturally in the middle of a track.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        threshold : float, optional</span>
<span class="sd">            A threshold, beyond which rows are removed (m/s). The default is 2.5.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># needs to be in a loop since if there is a fly-away point, you have going out and coming back</span>
        <span class="n">before</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad1index</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">1</span>  <span class="c1"># this sets up a record of the previous bad point this cannot be 0</span>
        <span class="p">)</span>

        <span class="c1"># in this loop there are speed limit issues to find and resolve</span>
        <span class="k">while</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_speed_wrt_ground&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="c1"># first bad point index:</span>
            <span class="n">bad1index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;platform_speed_wrt_ground&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold</span>
            <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># check to see if you are off the end of the data frame</span>
            <span class="k">if</span> <span class="n">bad1index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># the next point after this is:</span>
                <span class="n">next2badspd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">platform_speed_wrt_ground</span><span class="p">[</span><span class="n">bad1index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="c1"># it could be possible to look at bad1+2, etc but this may not be needed</span>

                <span class="k">if</span> <span class="n">bad1index</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad1index</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Track rows: track jump suspected (removed 2nd track point or &gt;1 sequential &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;positions - the next speed is </span><span class="si">{</span><span class="n">next2badspd</span><span class="si">}</span><span class="s2"> m/s), please rerun &quot;</span>
                        <span class="s2">&quot;w/ debug log to review&quot;</span>
                    <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Removing position at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">timestamp</span><span class="p">[</span><span class="n">bad1index</span><span class="p">]</span><span class="si">}</span><span class="s2"> at index </span><span class="si">{</span><span class="n">bad1index</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;due to speed limit violations - the next speed is </span><span class="si">{</span><span class="n">next2badspd</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> m/s)&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bad1index</span> <span class="o">=</span> <span class="n">bad1index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">bad1index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">speed</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Track rows: </span><span class="si">{</span><span class="n">before</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> rows removed due to speeds &gt; </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2"> m/s&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Track rows: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> - after speed filter&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">speedlimited</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad1index</span>

        <span class="c1"># recalculate stats here since things may have changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_stats</span><span class="p">()</span></div>


<div class="viewcode-block" id="Track.trim">
<a class="viewcode-back" href="../api.html#ibtd.Track.trim">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">trim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trim a track from data_start/end with trim_start/end to yield a track from track_start to _end.</span>

<span class="sd">        The trim_start and trim_end track properties are used to determine where to trim.</span>
<span class="sd">        These need to be provided intentionally (as an argument or read from track metadata)</span>
<span class="sd">        during the initialization of the track or they will be set to data_start and data_end</span>

<span class="sd">        Note that you will want to AFTER running the speed and speed limit, since the</span>
<span class="sd">        track_start and track_end will automatically be moved if bad data are found</span>
<span class="sd">        at the start and end of the track.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim_start</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim_start</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Values at the start of the track from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_start</span><span class="si">}</span><span class="s2"> up to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trim_start</span><span class="si">}</span><span class="s2"> were trimmed&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trimmed_start</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim_end</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim_end</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Values at the end of the track following </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trim_end</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_end</span><span class="si">}</span><span class="s2"> were trimmed&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trimmed_end</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Also flag that general trimming was done here.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trimmed</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># recalculate stats here since things may have changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_stats</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Track rows: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> after trim&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Track.geo">
<a class="viewcode-back" href="../api.html#ibtd.Track.geo">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">geo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a geodataframe of track points and a track line to the track object.</span>

<span class="sd">        This method converts track data into a geospatial points (self.trackpoints) and</span>
<span class="sd">        linestring (self.trackline).</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert to GeoPandas dataframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trackpoints</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">geometry</span><span class="o">=</span><span class="n">gpd</span><span class="o">.</span><span class="n">points_from_xy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;longitude&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;latitude&quot;</span><span class="p">]),</span>
        <span class="p">)</span>

        <span class="c1"># Set CRS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trackpoints</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="s2">&quot;EPSG:4326&quot;</span>

        <span class="c1"># Convert to line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trackline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trackpoints</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;platform_id&quot;</span><span class="p">])[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">LineString</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="p">)</span>

        <span class="c1"># Set CRS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trackline</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="s2">&quot;EPSG:4326&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geoed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Track geospatial data created&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Track.output">
<a class="viewcode-back" href="../api.html#ibtd.Track.output">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;csv&quot;</span><span class="p">],</span> <span class="n">path_output</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Output the track to a file.</span>

<span class="sd">        Note the default is a csv (non-spatial) format.  Other options include track points</span>
<span class="sd">        (_pt) or track lines (_ln) in a gpkg or kml file [let&#39;s move on from shapefiles, eh!].</span>
<span class="sd">        See types option below.</span>

<span class="sd">        The script checks for an existing file. If one is there, that will be logged.</span>
<span class="sd">        The file will not be overwritten and data export will fail.</span>

<span class="sd">        Notes about data formats:</span>
<span class="sd">            - the csv file is the output format &#39;of record&#39;</span>
<span class="sd">            - the gpkg _ln and _pt files are the recommended geospatial format. The _pt</span>
<span class="sd">              version contains and attribute table. Since the _pt data is a far larger</span>
<span class="sd">              file, it seemed like a good idea to keep _ln and _pt data separate.</span>
<span class="sd">            - the kml _ln and _pt files are meant for a quick look only (convienient to view):</span>
<span class="sd">                - there is no fancy symbology in the kml output.</span>
<span class="sd">                - the kml_pt output is restricted to platform_id and the timestamp.</span>
<span class="sd">                - sometimes the kml_pt file loads slowly.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        types : list of output types to generate [&#39;csv&#39;, &#39;pt_kml&#39;, &#39;ln_kml&#39;, &#39;pt_gpkg&#39;,&#39;ln_gpkg&#39;]. The default is &#39;csv&#39;.</span>
<span class="sd">        path_output : str, optional</span>
<span class="sd">            Path to put the output. The default is the current directory</span>
<span class="sd">        file_name : str, optional</span>
<span class="sd">            filename of output. The default is None, which will autogenerate on the platform_id</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_name</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform_id</span>

        <span class="k">if</span> <span class="n">types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># test if the geo method was run or not.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">geoed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">geo</span><span class="p">()</span>

        <span class="c1"># output part</span>
        <span class="k">if</span> <span class="s2">&quot;csv&quot;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="c1"># Write CSV file without index column</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_output</span><span class="p">,</span><span class="w"> </span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_output</span><span class="p">,</span><span class="w"> </span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span>
                    <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="c1"># date_format=&#39;%Y-%m-%d %H:%M:%S&#39;, # easy to read natively with Excel/Libre</span>
                    <span class="c1"># date_format=&quot;%Y-%m-%dT%H:%M:%SZ&quot;, # one ISO8601 format</span>
                    <span class="n">date_format</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%S%:z&quot;</span><span class="p">,</span>  <span class="c1"># another ISO8601 format (python 3.12 and up)</span>
                    <span class="n">na_rep</span><span class="o">=</span><span class="s2">&quot;NA&quot;</span><span class="p">,</span>  <span class="c1"># Sets no data to NA</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Track output as csv file&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;File already exists, writing as csv failed!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;pt_gpkg&quot;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_output</span><span class="p">,</span><span class="w"> </span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">_pt.gpkg&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trackpoints</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_output</span><span class="p">,</span><span class="w"> </span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">_pt.gpkg&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GPKG&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Track output as trackpoint gpkg file&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;File already exists, writing as trackpoint gpkg failed!&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;ln_gpkg&quot;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_output</span><span class="p">,</span><span class="w"> </span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">_ln.gpkg&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trackline</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_output</span><span class="p">,</span><span class="w"> </span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">_ln.gpkg&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GPKG&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Track output as trackline gpkg file&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;File already exists, writing as trackline gpkg failed!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;pt_kml&quot;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_output</span><span class="p">,</span><span class="w"> </span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">_pt.kml&quot;</span><span class="p">):</span>
                <span class="c1"># note the name will be the beacon id and the description will be the timestamp.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trackpoints</span><span class="p">[[</span><span class="s2">&quot;platform_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_output</span><span class="p">,</span><span class="w"> </span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">_pt.kml&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;KML&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Track output as trackpoint kml file&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;File already exists, writing as trackpoint kml failed!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;ln_kml&quot;</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_output</span><span class="p">,</span><span class="w"> </span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">_ln.kml&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trackline</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_output</span><span class="p">,</span><span class="w"> </span><span class="n">file_name</span><span class="p">)</span><span class="si">}</span><span class="s2">_ln.kml&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;KML&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Track output as trackline kml file&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;File already exists, writing as trackline kml failed!&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Track.resample">
<a class="viewcode-back" href="../api.html#ibtd.Track.resample">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestep</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="n">agg_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resample track to a given time step.</span>

<span class="sd">        Timestep can be D for daily or h for hourly or multiples of D or h (eg &#39;7D&#39;, &#39;12h&#39;)</span>
<span class="sd">        After resampling other track properties will be refreshed.</span>
<span class="sd">        Other agg_fuctions might be wanted (max?, min?) but these are not implemented.</span>
<span class="sd">        One day maybe there will be interpolations?</span>

<span class="sd">        Since the track data and properies will be overwritten, it is a good idea to make</span>
<span class="sd">        a copy first:</span>
<span class="sd">        - track_6h = copy.deepcopy(track)</span>
<span class="sd">        - track_6h.resample(timestep=&quot;6h&quot;)</span>

<span class="sd">        Note this method has not been thoroughly tested!</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        timestep : str, optional</span>
<span class="sd">            Give the code for the timestep to sample to. The default is &quot;D&quot;. See above.</span>
<span class="sd">        agg_function : str, optional</span>
<span class="sd">            Aggregation function: median, mean, None. The default is None.</span>
<span class="sd">        first : bool, optional</span>
<span class="sd">            If agg_fuction is none, or for columns that cannot be aggregated,</span>
<span class="sd">                take first (True) or last (False) value for the time period. The default</span>
<span class="sd">                is True.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="c1"># need to have a datetime index or use the &#39;on&#39; keyword</span>
        <span class="n">sdf</span> <span class="o">=</span> <span class="n">sdf</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span>
        <span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">sdf</span><span class="o">.</span><span class="n">platform_orientation</span><span class="p">))</span>
        <span class="n">sdf</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">sdf</span><span class="o">.</span><span class="n">platform_orientation</span><span class="p">))</span>

        <span class="c1"># https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.resample.html</span>
        <span class="c1"># Note that you can control whether bin intervals are closed on left or right</span>
        <span class="c1"># and which label to use.  e.g., daily, closed left with left label:</span>
        <span class="c1">#   All data from 2024-08-02 00:00:00 to 2024-08-02 23:59:59 are in August 2.</span>
        <span class="c1"># Weekly and Montly have different behaviour by default so use use &#39;7D&#39; instead</span>
        <span class="c1"># of &#39;W&#39; for weekly resampling for consistency</span>
        <span class="c1"># https://pandas.pydata.org/pandas-docs/stable/reference/groupby.html#api-groupby</span>

        <span class="k">if</span> <span class="n">agg_function</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                <span class="n">number_f</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">number_f</span> <span class="o">=</span> <span class="s2">&quot;last&quot;</span>
        <span class="k">elif</span> <span class="n">agg_function</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
            <span class="n">number_f</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span>
        <span class="k">elif</span> <span class="n">agg_function</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
            <span class="n">number_f</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Check resampling parameters&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Check resampling parameters&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
            <span class="n">string_f</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">string_f</span> <span class="o">=</span> <span class="s2">&quot;last&quot;</span>

        <span class="c1"># this sort of thing is trivial</span>
        <span class="c1"># sdf.resample(&quot;D&quot;).last()</span>
        <span class="c1"># sdf.resample(&quot;D&quot;).first()</span>

        <span class="c1"># with mixed data types the way you aggregate needs to be controlled for each column</span>
        <span class="n">sdf_</span> <span class="o">=</span> <span class="n">sdf</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">timestep</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
            <span class="n">platform_id</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;platform_id&quot;</span><span class="p">,</span> <span class="n">string_f</span><span class="p">),</span>
            <span class="n">latitude</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span> <span class="n">number_f</span><span class="p">),</span>
            <span class="n">longitude</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span> <span class="n">number_f</span><span class="p">),</span>
            <span class="n">air_temperature</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;air_temperature&quot;</span><span class="p">,</span> <span class="n">number_f</span><span class="p">),</span>
            <span class="n">internal_temperature</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;internal_temperature&quot;</span><span class="p">,</span> <span class="n">number_f</span><span class="p">),</span>
            <span class="n">surface_temperature</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;surface_temperature&quot;</span><span class="p">,</span> <span class="n">number_f</span><span class="p">),</span>
            <span class="n">air_pressure</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;air_pressure&quot;</span><span class="p">,</span> <span class="n">number_f</span><span class="p">),</span>
            <span class="n">platform_pitch</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;platform_pitch&quot;</span><span class="p">,</span> <span class="n">number_f</span><span class="p">),</span>
            <span class="n">platform_roll</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;platform_roll&quot;</span><span class="p">,</span> <span class="n">number_f</span><span class="p">),</span>
            <span class="n">platform_orientation</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;platform_orientation&quot;</span><span class="p">,</span> <span class="n">string_f</span><span class="p">),</span>
            <span class="n">voltage_battery_volts</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;voltage_battery_volts&quot;</span><span class="p">,</span> <span class="n">number_f</span><span class="p">),</span>
            <span class="n">u</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="n">number_f</span><span class="p">),</span>
            <span class="n">v</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="n">number_f</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">sdf_</span><span class="p">[</span><span class="s2">&quot;platform_orientation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">360</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">sdf_</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="n">sdf_</span><span class="o">.</span><span class="n">v</span><span class="p">))</span>
        <span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">sdf_</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># after doing the resampling it will be important to run:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_stats</span><span class="p">()</span></div>


<div class="viewcode-block" id="Track.track_metadata">
<a class="viewcode-back" href="../api.html#ibtd.Track.track_metadata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">track_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_output</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">meta_export</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a dataframe and dictionary of the known track metadata for export.</span>

<span class="sd">        Put metadata into categories. The json is nested but the dataframe is not.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path_output : str, optional</span>
<span class="sd">            path where the output should be saved.  The default is the current directory.</span>
<span class="sd">        meta_export : str, optional</span>
<span class="sd">            Specify &#39;pandas&#39; or &#39;json&#39; format or &#39;both&#39;. The default (None) does not export a file.</span>
<span class="sd">        verbose : Bool</span>
<span class="sd">            If true, return/export all the metadata, otherwise only the most useful.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        track_meta : pandas dataframe</span>
<span class="sd">            available track metadata.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get all the properties of the track</span>
        <span class="n">t_meta</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

        <span class="c1"># get the extra metadata for the beacon here if available</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;meta_dict&quot;</span><span class="p">):</span>
            <span class="n">x_meta</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meta_dict</span><span class="p">)</span>
            <span class="n">t_meta</span> <span class="o">=</span> <span class="n">t_meta</span> <span class="o">|</span> <span class="n">x_meta</span>

        <span class="c1"># don&#39;t want every entry: this is data or log</span>
        <span class="n">remove_keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;log&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;meta_dict&quot;</span><span class="p">,</span>
            <span class="s2">&quot;trackpoints&quot;</span><span class="p">,</span>
            <span class="s2">&quot;trackline&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">remove_keys</span><span class="p">:</span>
            <span class="n">t_meta</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Use pop to avoid KeyError if key doesn&#39;t exist</span>

        <span class="c1"># now parse out the metadata fields based on what categories are defined:</span>
        <span class="n">identifier_metadata</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;platform_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;year&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wmo&quot;</span><span class="p">,</span>
            <span class="s2">&quot;iceberg_name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;iceberg_source&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">format_metadata</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;reader&quot;</span><span class="p">]</span>

        <span class="n">comments_metadata</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;comments&quot;</span><span class="p">]</span>

        <span class="n">track_metadata</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;track_start&quot;</span><span class="p">,</span>
            <span class="s2">&quot;track_end&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data_start&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data_end&quot;</span><span class="p">,</span>
            <span class="s2">&quot;trim_start&quot;</span><span class="p">,</span>
            <span class="s2">&quot;trim_end&quot;</span><span class="p">,</span>
            <span class="s2">&quot;trim_start_flag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;trim_end_flag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latitude_start&quot;</span><span class="p">,</span>
            <span class="s2">&quot;longitude_start&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latitude_end&quot;</span><span class="p">,</span>
            <span class="s2">&quot;longitude_end&quot;</span><span class="p">,</span>
            <span class="s2">&quot;observations&quot;</span><span class="p">,</span>
            <span class="s2">&quot;duration&quot;</span><span class="p">,</span>
            <span class="s2">&quot;distance_travelled&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">project_metadata</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;project&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data_contributor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data_contact&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data_contact_email&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">deployment_metadata</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;deployed_by&quot;</span><span class="p">,</span>
            <span class="s2">&quot;deployment_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;deployment_platform&quot;</span><span class="p">,</span>
            <span class="s2">&quot;photo_credit&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">morphology_metadata</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;shape&quot;</span><span class="p">,</span>
            <span class="s2">&quot;size&quot;</span><span class="p">,</span>
            <span class="s2">&quot;length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;length_flag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;width&quot;</span><span class="p">,</span>
            <span class="s2">&quot;width_flag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;area&quot;</span><span class="p">,</span>
            <span class="s2">&quot;area_flag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;height&quot;</span><span class="p">,</span>
            <span class="s2">&quot;height_flag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;thickness&quot;</span><span class="p">,</span>
            <span class="s2">&quot;thickness_flag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;draft&quot;</span><span class="p">,</span>
            <span class="s2">&quot;draft_flag&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">beacon_metadata</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;model&quot;</span><span class="p">,</span>
            <span class="s2">&quot;make&quot;</span><span class="p">,</span>
            <span class="s2">&quot;transmitter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;air_deployable&quot;</span><span class="p">,</span>
            <span class="s2">&quot;buoyant&quot;</span><span class="p">,</span>
            <span class="s2">&quot;has_internal_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;has_surface_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;has_air_temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;has_voltage_battery_volts&quot;</span><span class="p">,</span>
            <span class="s2">&quot;has_air_pressure&quot;</span><span class="p">,</span>
            <span class="s2">&quot;has_platform_pitch&quot;</span><span class="p">,</span>
            <span class="s2">&quot;has_platform_roll&quot;</span><span class="p">,</span>
            <span class="s2">&quot;has_platform_orientation&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">valid_range_metadata</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;latitude_min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latitude_max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;longitude_min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;longitude_max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;air_temperature_min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;air_temperature_max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;internal_temperature_min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;internal_temperature_max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surface_temperature_min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;surface_temperature_max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;air_pressure_min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;air_pressure_max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;platform_pitch_min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;platform_pitch_max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;platform_roll_min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;platform_roll_max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;platform_orientation_min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;platform_orientation_max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;voltage_battery_volts_min&quot;</span><span class="p">,</span>
            <span class="s2">&quot;voltage_battery_volts_max&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="n">process_metadata</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;datafile&quot;</span><span class="p">,</span>
            <span class="s2">&quot;raw_data&quot;</span><span class="p">,</span>
            <span class="s2">&quot;purged&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sorted&quot;</span><span class="p">,</span>
            <span class="s2">&quot;speeded&quot;</span><span class="p">,</span>
            <span class="s2">&quot;speedlimited&quot;</span><span class="p">,</span>
            <span class="s2">&quot;trimmed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;trimmed_start&quot;</span><span class="p">,</span>
            <span class="s2">&quot;trimmed_end&quot;</span><span class="p">,</span>
            <span class="s2">&quot;geoed&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># Create dictionaries based on each of the categories</span>
        <span class="n">beacon_metadata_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">t_meta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">beacon_metadata</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">t_meta</span><span class="p">}</span>
        <span class="n">comments_metadata_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">t_meta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">comments_metadata</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">t_meta</span>
        <span class="p">}</span>
        <span class="n">deployment_metadata_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">t_meta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">deployment_metadata</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">t_meta</span>
        <span class="p">}</span>
        <span class="n">format_metadata_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">t_meta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">format_metadata</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">t_meta</span><span class="p">}</span>
        <span class="n">identifier_metadata_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">t_meta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">identifier_metadata</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">t_meta</span>
        <span class="p">}</span>
        <span class="n">morphology_metadata_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">t_meta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">morphology_metadata</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">t_meta</span>
        <span class="p">}</span>
        <span class="n">process_metadata_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">t_meta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">process_metadata</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">t_meta</span><span class="p">}</span>
        <span class="n">project_metadata_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">t_meta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">project_metadata</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">t_meta</span><span class="p">}</span>
        <span class="n">track_metadata_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">t_meta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">track_metadata</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">t_meta</span><span class="p">}</span>
        <span class="n">valid_range_metadata_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">t_meta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_range_metadata</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">t_meta</span>
        <span class="p">}</span>

        <span class="n">excluded_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
            <span class="n">beacon_metadata</span><span class="p">,</span>
            <span class="n">comments_metadata</span><span class="p">,</span>
            <span class="n">deployment_metadata</span><span class="p">,</span>
            <span class="n">format_metadata</span><span class="p">,</span>
            <span class="n">identifier_metadata</span><span class="p">,</span>
            <span class="n">morphology_metadata</span><span class="p">,</span>
            <span class="n">process_metadata</span><span class="p">,</span>
            <span class="n">project_metadata</span><span class="p">,</span>
            <span class="n">track_metadata</span><span class="p">,</span>
            <span class="n">valid_range_metadata</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">leftover_metadata_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">t_meta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">t_meta</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluded_keys</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">track_meta_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;identifier_metadata&quot;</span><span class="p">:</span> <span class="n">identifier_metadata_dict</span><span class="p">,</span>
                <span class="s2">&quot;track_metadata&quot;</span><span class="p">:</span> <span class="n">track_metadata_dict</span><span class="p">,</span>
                <span class="s2">&quot;project_metadata&quot;</span><span class="p">:</span> <span class="n">project_metadata_dict</span><span class="p">,</span>
                <span class="s2">&quot;deployment_metadata&quot;</span><span class="p">:</span> <span class="n">deployment_metadata_dict</span><span class="p">,</span>
                <span class="s2">&quot;format_metadata&quot;</span><span class="p">:</span> <span class="n">format_metadata_dict</span><span class="p">,</span>
                <span class="s2">&quot;morphology_metadata&quot;</span><span class="p">:</span> <span class="n">morphology_metadata_dict</span><span class="p">,</span>
                <span class="s2">&quot;comments_metadata&quot;</span><span class="p">:</span> <span class="n">comments_metadata_dict</span><span class="p">,</span>
                <span class="s2">&quot;beacon_metadata&quot;</span><span class="p">:</span> <span class="n">beacon_metadata_dict</span><span class="p">,</span>
                <span class="s2">&quot;process_metadata&quot;</span><span class="p">:</span> <span class="n">process_metadata_dict</span><span class="p">,</span>
                <span class="s2">&quot;valid_range_metadata&quot;</span><span class="p">:</span> <span class="n">valid_range_metadata_dict</span><span class="p">,</span>
                <span class="s2">&quot;leftover_metadata&quot;</span><span class="p">:</span> <span class="n">leftover_metadata_dict</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">track_meta_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;identifier_metadata&quot;</span><span class="p">:</span> <span class="n">identifier_metadata_dict</span><span class="p">,</span>
                <span class="s2">&quot;track_metadata&quot;</span><span class="p">:</span> <span class="n">track_metadata_dict</span><span class="p">,</span>
                <span class="s2">&quot;project_metadata&quot;</span><span class="p">:</span> <span class="n">project_metadata_dict</span><span class="p">,</span>
                <span class="s2">&quot;deployment_metadata&quot;</span><span class="p">:</span> <span class="n">deployment_metadata_dict</span><span class="p">,</span>
                <span class="s2">&quot;format_metadata&quot;</span><span class="p">:</span> <span class="n">format_metadata_dict</span><span class="p">,</span>
                <span class="s2">&quot;morphology_metadata&quot;</span><span class="p">:</span> <span class="n">morphology_metadata_dict</span><span class="p">,</span>
                <span class="s2">&quot;comments_metadata&quot;</span><span class="p">:</span> <span class="n">comments_metadata_dict</span><span class="p">,</span>
                <span class="s2">&quot;beacon_metadata&quot;</span><span class="p">:</span> <span class="n">beacon_metadata_dict</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="n">flattened</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">meta_category</span><span class="p">,</span> <span class="n">meta_category_dict</span> <span class="ow">in</span> <span class="n">track_meta_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">meta_category_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">flattened</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># Convert to DataFrame</span>
        <span class="n">track_meta_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">flattened</span><span class="p">])</span>

        <span class="c1"># order columns</span>
        <span class="n">col_order</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">identifier_metadata</span>
            <span class="o">+</span> <span class="n">track_metadata</span>
            <span class="o">+</span> <span class="n">project_metadata</span>
            <span class="o">+</span> <span class="n">deployment_metadata</span>
            <span class="o">+</span> <span class="n">format_metadata</span>
            <span class="o">+</span> <span class="n">morphology_metadata</span>
            <span class="o">+</span> <span class="n">comments_metadata</span>
            <span class="o">+</span> <span class="n">beacon_metadata</span>
            <span class="o">+</span> <span class="n">process_metadata</span>
            <span class="o">+</span> <span class="n">valid_range_metadata</span>
            <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">leftover_metadata_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">)</span>

        <span class="n">new_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">col_order</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">track_meta_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">track_meta_df</span> <span class="o">=</span> <span class="n">track_meta_df</span><span class="p">[</span><span class="n">new_columns</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">meta_export</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span> <span class="ow">or</span> <span class="n">meta_export</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="n">track_meta_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="n">track_meta_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">json_serialize</span>
            <span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">path_output</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">platform_id</span><span class="si">}</span><span class="s2">_meta.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">file_export</span><span class="p">:</span>
                <span class="n">file_export</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">track_meta_json</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">meta_export</span> <span class="o">==</span> <span class="s2">&quot;pandas&quot;</span> <span class="ow">or</span> <span class="n">meta_export</span> <span class="o">==</span> <span class="s2">&quot;both&quot;</span><span class="p">:</span>
            <span class="n">track_meta_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">path_output</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">platform_id</span><span class="si">}</span><span class="s2">_meta.csv&quot;</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">na_rep</span><span class="o">=</span><span class="s2">&quot;NA&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">track_meta_df</span></div>


    <span class="c1"># The following graphing functions are in track_fig.py but listed here so they can</span>
    <span class="c1"># be a method of Track.</span>

<div class="viewcode-block" id="Track.plot_map">
<a class="viewcode-back" href="../api.html#ibtd.Track.plot_map">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_output</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a map of the track.</span>

<span class="sd">        See track_fig.py for more details.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path_output : str, optional</span>
<span class="sd">            Path to save output. The default is the current directory.</span>
<span class="sd">        dpi : int, optional</span>
<span class="sd">            Resolution of the graph in dots per inch. The default is 300.</span>
<span class="sd">        interactive: bool</span>
<span class="sd">            Create an interactive map that can be panned and zoomed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># call the function in track_fig.py</span>
        <span class="n">plot_map</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">path_output</span><span class="o">=</span><span class="n">path_output</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span>
            <span class="n">interactive</span><span class="o">=</span><span class="n">interactive</span><span class="p">,</span>
            <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Track.plot_trim">
<a class="viewcode-back" href="../api.html#ibtd.Track.plot_trim">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_trim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_output</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a trim diagnostic graph for the track.</span>

<span class="sd">        See track_fig.py for more details.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path_output : str, optional</span>
<span class="sd">            Path to save output. The default is the current directory.</span>
<span class="sd">        dpi : int, optional</span>
<span class="sd">            Resolution of the graph in dots per inch. The default is 300.</span>
<span class="sd">        interactive: bool</span>
<span class="sd">            Create an interactive map that can be panned and zoomed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># call the function in track_fig.py</span>
        <span class="n">plot_trim</span><span class="p">(</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
                <span class="bp">self</span>
            <span class="p">),</span>  <span class="c1"># since the function modifies the track, work with copy</span>
            <span class="n">path_output</span><span class="o">=</span><span class="n">path_output</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span>
            <span class="n">interactive</span><span class="o">=</span><span class="n">interactive</span><span class="p">,</span>
            <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Track.plot_dist">
<a class="viewcode-back" href="../api.html#ibtd.Track.plot_dist">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_dist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_output</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot distributions along the track.</span>

<span class="sd">        See track_fig.py for more details.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path_output : str, optional</span>
<span class="sd">            Path to save output. The default is the current directory.</span>
<span class="sd">        dpi : int, optional</span>
<span class="sd">            Resolution of the graph in dots per inch. The default is 300.</span>
<span class="sd">        interactive: bool</span>
<span class="sd">            Create an interactive map that can be panned and zoomed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># call the function in track_fig.py</span>
        <span class="n">plot_dist</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">path_output</span><span class="o">=</span><span class="n">path_output</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span>
            <span class="n">interactive</span><span class="o">=</span><span class="n">interactive</span><span class="p">,</span>
            <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Track.plot_time">
<a class="viewcode-back" href="../api.html#ibtd.Track.plot_time">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_output</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot a timeseries of the track.</span>

<span class="sd">        See track_fig.py for more details.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path_output : str, optional</span>
<span class="sd">            Path to save output. The default is the current directory.</span>
<span class="sd">        dpi : int, optional</span>
<span class="sd">            Resolution of the graph in dots per inch. The default is 300.</span>
<span class="sd">        interactive: bool</span>
<span class="sd">            Create an interactive map that can be panned and zoomed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># call the function in track_fig.py</span>
        <span class="n">plot_time</span><span class="p">(</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span>
                <span class="bp">self</span>
            <span class="p">),</span>  <span class="c1"># since the function modifies the track, work with copy</span>
            <span class="n">path_output</span><span class="o">=</span><span class="n">path_output</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span>
            <span class="n">interactive</span><span class="o">=</span><span class="n">interactive</span><span class="p">,</span>
            <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Iceberg Beacon Track Database (IBTD) Tools</a></h1>









<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../README.html">Iceberg Beacon Track Database (IBTD) Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#api-reference">API Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2025, WIRL.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>